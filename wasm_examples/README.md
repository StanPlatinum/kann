# Run kann in wasm

## build original mnist-cnn (in kann)


repo:
https://github.com/attractivechaos/kann/tree/master/examples


compile using gcc
```
cd examples
make
```

run the example
```
./mnist-cnn -o mnist-cnn.kan -t4 kann-data/mnist-train-?.knd.gz
./mnist-cnn -i mnist-cnn.kan kann-data/mnist-test-x.knd.gz | kann-data/mnist-eval.pl
```


## build WAMR execution environment

First you might need a runable SGX machine and SGX environment (driver & Intel SGXSDK)

### build WAMR & WASI SDK (and its clang)

check out the blog "WAMR Installation & run in SGX enclave" on 
https://ya0guang.com/tiddly/output/notebook.html

Here you should have a compiler `clang-11` (in `wasi-sdk-12.0/bin/`) and a loader `iwasm` (in `wasm-micro-runtime/product-mini/platforms/linux-sgx/enclave-sample`)


## build the wasm app version of mnist-cnn

using the clang provided by the WASI SDK

### modify the Makefile

modify the makefile at `kann/Makefile`

change CC

```
# CC=			gcc
CC=/usr/local/src/wasi-sdk-12.0/bin/clang-11 --sysroot=/usr/local/src/wasi-sdk-12.0/share/wasi-sysroot

```

`/usr/local/src/wasi-sdk-12.0` is the dir of WASI SDK

disable pthread and zlib dependency

```
# CPPFLAGS=	-DHAVE_PTHREAD

...

# LIBS=		-lpthread -lz -lm
LIBS=		-lm

...

kann_extra/kann_data.o:kann_extra/kann_data.c
		# $(CC) -c $(CFLAGS) -DHAVE_ZLIB $< -o $@
		$(CC) -c $(CFLAGS) $< -o $@
```

then,

`make clean && make`

you can get a wasm app version of `mnist`, at `kann/example`

### run the wasm app

#### config and re-build the iwasm loader

enlarge the iwasm's enclave heap/stack size, at `wasm-micro-runtime/product-mini/platforms/linux-sgx/enclave-sample/Enclave/Enclave.config.xml`

```
<StackMaxSize>0x10000000</StackMaxSize>
<HeapMaxSize>0x20000000</HeapMaxSize>
<ReservedMemMaxSize>0x10000000</ReservedMemMaxSize>
```

then, re-make the iwasm

#### run the wasm file

Since the libz has not been integrated into the wasm, you have to run the without using .gz. So we have to replace the `kann-data/mnist-test-x.knd.gz` with `kann-data/mnist-test-x.knd`. The `kann-data/mnist-test-x.knd` can be generated by
```
gzip mnist-test-x.knd.gz -d
```

run mnist-cnn with iwasm
```
/usr/local/src/wasm-micro-runtime/product-mini/platforms/linux-sgx/enclave-sample/iwasm --stack-size=32000000 --heap-size=64000000 --dir=./kann-data --dir=./  ./mnist-cnn -i  mnist-cnn.kan kann-data/mnist-test-x.knd
```

### run the wasm app in a AoT way

#### build the wamrc

https://github.com/bytecodealliance/wasm-micro-runtime#build-wamrc-aot-compiler

#### turn wasm app to AoT binary

usage:
https://github.com/bytecodealliance/wasm-micro-runtime/blob/main/doc/build_wasm_app.md#compile-wasm-to-aot-module

```
/usr/local/src/wasm-micro-runtime/wamr-compiler/build/wamrc --size-level=1 -sgx -o mnist-cnn.aot mnist-cnn
```

#### run mnist-cnn.aot
```
/usr/local/src/wasm-micro-runtime/product-mini/platforms/linux-sgx/enclave-sample/iwasm --stack-size=32000000 --heap-size=64000000 --dir=./kann-data --dir=./  ./mnist-cnn.aot -i  mnist-cnn.kan kann-data/mnist-test-x.knd
```
